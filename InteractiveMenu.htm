<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Class+ Menu</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #ef4444; 
            --secondary: #111827;
            --background: #fafafa;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--secondary);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.06);
        }

        .item-card {
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            opacity: 0;
            transform: translateY(25px);
        }
        .item-card.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .item-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 35px -8px rgba(0, 0, 0, 0.08);
        }

        .category-tab, .sort-btn {
            position: relative;
            transition: all 0.4s ease;
            white-space: nowrap;
            text-transform: uppercase;
            font-weight: 800;
            z-index: 10;
        }

        .category-tab {
            letter-spacing: 0.12em;
            font-size: 0.65rem;
            padding: 0.6rem 0.75rem;
        }

        .active-tab, .active-sort { color: white !important; }

        #nav-indicator, #sort-indicator {
            position: absolute;
            background-color: var(--primary);
            border-radius: 9999px;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1;
            pointer-events: none;
        }

        #nav-indicator { height: 34px; top: 0; } 
        #sort-indicator { height: 28px; top: 4px; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes nudge-swipe {
            0% { transform: translateX(0); }
            30% { transform: translateX(60px); }
            100% { transform: translateX(0); }
        }
        .nudge-active {
            animation: nudge-swipe 1.2s cubic-bezier(0.45, 0, 0.55, 1);
        }

        .logo-animated {
            width: 240px;
            height: 52px;
            background: linear-gradient(45deg, #ef4444, #ef4444, #ef4444, #facc15, #38bdf8, #ef4444);
            background-size: 300% 300%;
            -webkit-mask: url("https://images.prismic.io/worldclass/aVxQ23NYClf9ozTn_WorldClass%2B_Logo_black.png?auto=format,compress") no-repeat center;
            mask: url("https://images.prismic.io/worldclass/aVxQ23NYClf9ozTn_WorldClass%2B_Logo_black.png?auto=format,compress") no-repeat center;
            -webkit-mask-size: contain;
            mask-size: contain;
            animation: logoGradientFlow 8s ease infinite;
        }

        @keyframes logoGradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .macro-circle { transform-origin: center; }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            width: 200px;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
            z-index: 100;
        }
        .dropdown-menu.active { display: block; }

        .card-macro-grid {
            border-top: 1px solid rgba(243, 244, 246, 1);
            padding-top: 1rem;
            margin-top: 1rem;
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
        
        .sort-arrow-svg {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-left: 4px;
            transition: transform 0.3s ease;
            vertical-align: middle;
        }
        .sort-arrow-svg.desc {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="antialiased selection:bg-red-100 selection:text-red-600">

    <div id="loading-overlay">
        <div class="logo-animated opacity-50"></div>
    </div>

    <div class="max-w-4xl mx-auto px-4 pt-6 pb-8 sm:pt-12">
        
        <!-- Haus -->
        <header class="flex flex-col items-center mb-10 sm:mb-16">
            <div class="w-full flex justify-end items-center gap-3 mb-10">
                
                <!-- Location Dropdown -->
                <div class="relative">
                    <button onclick="toggleLocMenu()" class="flex items-center gap-2 bg-white border border-gray-100 px-3 py-2 rounded-full shadow-sm hover:shadow-md transition-all active:scale-95">
                        <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        <span id="active-loc-name" class="text-[10px] font-black uppercase tracking-widest text-gray-700">Laugar</span>
                    </button>
                    
                    <div id="loc-dropdown" class="dropdown-menu overflow-hidden p-2">
                        <button onclick="setLocation('LAUGAR')" class="w-full text-left px-4 py-3 text-[10px] font-black uppercase tracking-widest hover:bg-gray-50 rounded-xl transition-colors">Laugar (Allt)</button>
                        <button onclick="setLocation('VATNSMYRI')" class="w-full text-left px-4 py-3 text-[10px] font-black uppercase tracking-widest hover:bg-gray-50 rounded-xl transition-colors border-t border-gray-50">Vatnsmýri</button>
                        <button onclick="setLocation('SELTJARNARNES')" class="w-full text-left px-4 py-3 text-[10px] font-black uppercase tracking-widest hover:bg-gray-50 rounded-xl transition-colors border-t border-gray-50">Seltjarnarnes</button>
                    </div>
                </div>

                <!-- Language Toggle -->
                <button onclick="toggleLanguage()" class="focus:outline-none group">
                    <div id="lang-flag-container" class="w-8 h-8 rounded-full overflow-hidden border-2 border-white shadow-md transition-all group-hover:scale-110 group-hover:shadow-lg">
                        <img id="lang-flag-img" src="https://flagcdn.com/w80/is.png" class="w-full h-full object-cover" alt="Flag">
                    </div>
                </button>
            </div>
            
            <div class="logo-animated mb-6"></div>
            <p id="tagline" class="text-gray-400 font-bold text-[10px] text-center tracking-[0.2em] uppercase"></p>
        </header>

        <!-- Sýnar-val -->
        <div class="flex flex-col items-center gap-6 mb-12 relative z-30">
            <div class="bg-gray-100/90 p-1 rounded-2xl flex gap-1 border border-gray-200/40 w-full max-w-[280px] relative shadow-inner">
                <button onclick="setViewMode('categories')" id="mode-categories" class="view-toggle-btn flex-1 py-2.5 rounded-xl text-[10px] transition-all uppercase font-black tracking-widest z-10">Flokkar</button>
                <button onclick="setViewMode('themes')" id="mode-themes" class="view-toggle-btn flex-1 py-2.5 rounded-xl text-[10px] transition-all uppercase font-black tracking-widest z-10">Markmið</button>
            </div>
        </div>

        <div id="scroll-anchor" class="h-px w-full -mt-8"></div>

        <!-- Síustikur -->
        <div id="category-container" class="sticky top-6 z-50 mb-10 hidden">
            <div class="glass rounded-[2rem] overflow-hidden">
                <div class="scroll-mask-container">
                    <nav id="category-scroll-container" class="flex overflow-x-auto no-scrollbar w-full py-4 px-4 justify-start items-center relative">
                        <!-- Category tabs með position relative svo vísirinn lendi rétt -->
                        <div id="category-tabs" class="flex gap-0 min-w-full items-center relative">
                            <div id="nav-indicator"></div>
                            <!-- Takkarnir fara hingað -->
                        </div>
                    </nav>
                </div>
            </div>
        </div>
        <div id="theme-container" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-12 hidden"></div>

        <!-- Hero -->
        <div class="mb-10">
            <div id="category-hero" class="rounded-[2.5rem] overflow-hidden shadow-xl relative h-44 sm:h-80 hidden animate-slide-up">
                <img id="hero-img" src="" class="w-full h-full object-cover transition-opacity duration-500" alt="Hero" onerror="this.src='https://images.prismic.io/worldclass/aVxY43NYClf9ozUz_menu_21920.jpg?auto=format,compress'">
                <div id="hero-color-overlay" class="absolute inset-0 transition-all duration-300 pointer-events-none mix-blend-multiply opacity-0 z-10"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent flex items-end p-8 sm:p-12 z-20">
                    <h2 id="hero-title" class="text-white text-3xl sm:text-6xl font-black uppercase tracking-tighter"></h2>
                </div>
            </div>
        </div>

        <!-- Röðunarstika -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-10 px-2">
            <div class="flex items-center gap-3">
                <span id="sort-label" class="text-[9px] font-black uppercase tracking-[0.2em] text-gray-400">Raða eftir:</span>
            </div>
            <div class="bg-gray-100/50 p-1 rounded-full border border-gray-200/50 flex-1 overflow-hidden relative">
                <div class="flex gap-2 overflow-x-auto no-scrollbar relative p-1" id="sort-tabs-container">
                    <div id="sort-indicator"></div>
                    <button onclick="setSort('kcal')" id="sort-kcal" class="sort-btn px-4 py-1.5 rounded-full text-[9px] transition-all duration-300 uppercase font-bold flex items-center gap-1">Kcal</button>
                    <button onclick="setSort('protein')" id="sort-protein" class="sort-btn px-4 py-1.5 rounded-full text-[9px] transition-all duration-300 uppercase font-bold flex items-center gap-1">Prótein</button>
                    <button onclick="setSort('carbs')" id="sort-carbs" class="sort-btn px-4 py-1.5 rounded-full text-[9px] transition-all duration-300 uppercase font-bold flex items-center gap-1">Kolv</button>
                    <button onclick="setSort('fat')" id="sort-fat" class="sort-btn px-4 py-1.5 rounded-full text-[9px] transition-all duration-300 uppercase font-bold flex items-center gap-1">Fita</button>
                    <button onclick="setSort('category')" id="sort-category" class="sort-btn px-4 py-1.5 rounded-full text-[9px] transition-all duration-300 uppercase font-bold flex items-center gap-1">Flokkar</button>
                </div>
            </div>
        </div>

        <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 min-h-[400px]"></div>

        <footer class="mt-24 text-center pb-16">
            <p class="text-gray-300 text-[11px] font-bold tracking-[0.3em] uppercase text-center">World Class &copy; 2026</p>
        </footer>
    </div>

    <!-- Modal (Popup) -->
    <div id="item-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4 bg-gray-950/40 backdrop-blur-sm" onclick="closeModal()">
        <div class="bg-white rounded-[3rem] shadow-2xl max-w-md w-full overflow-hidden transform scale-95 opacity-0 transition-all duration-300 relative" id="modal-content" onclick="event.stopPropagation()">
            <div class="absolute top-6 right-6 z-50 flex gap-2 export-hide">
                <button id="share-img-btn" onclick="shareAsImage()" aria-label="Share as image" class="bg-gray-50 p-2.5 rounded-full hover:bg-white text-gray-400 hover:text-blue-500 border border-gray-100 transition-all shadow-sm active:scale-90">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                </button>
                <button onclick="closeModal()" aria-label="Close" class="bg-gray-50 p-2.5 rounded-full hover:bg-white text-gray-400 hover:text-red-500 border border-gray-100 transition-all shadow-sm active:scale-90">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div id="export-container" class="p-8 sm:p-10 bg-white" style="border-radius: 3rem;">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex flex-wrap gap-2.5 items-center">
                        <span id="modal-tag" class="text-[9px] font-black px-2.5 py-1.5 rounded-lg text-white uppercase tracking-widest shadow-sm"></span>
                        <span id="modal-vegan" class="hidden text-[9px] font-black px-2.5 py-1.5 bg-green-500/10 text-green-600 rounded-lg uppercase tracking-widest border border-green-500/20">Vegan</span>
                    </div>
                    <img id="modal-logo-export" 
                         src="https://images.prismic.io/worldclass/aVxQ23NYClf9ozTn_WorldClass%2B_Logo_black.png?auto=format,compress" 
                         crossorigin="anonymous" 
                         alt="World Class Logo" 
                         class="hidden w-24 sm:w-32 h-auto object-contain flex-shrink-0"
                         style="image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges;">
                </div>
                
                <h2 id="modal-title" class="text-3xl sm:text-4xl font-black text-gray-900 leading-tight mb-4 tracking-tighter"></h2>
                <div id="modal-price-container" class="mb-10 export-hide"></div>
                <div id="modal-ingredients-container" class="mb-10">
                    <h4 id="label-ingredients" class="text-[9px] font-black uppercase tracking-[0.25em] text-gray-300 mb-2">Innihaldslýsing</h4>
                    <p id="modal-description" class="text-gray-700 leading-relaxed text-[14px] font-medium"></p>
                </div>

                <div class="space-y-8">
                    <div id="modal-nutrition-section" class="bg-gray-50/50 rounded-[2.5rem] p-8 border border-gray-100/50 hidden">
                        <div class="flex justify-between items-center mb-8">
                            <h4 id="label-nutrition" class="text-[10px] font-black uppercase tracking-[0.25em] text-gray-300">Næringargildi</h4>
                            <div id="modal-sizes" class="flex gap-2 export-hide"></div>
                        </div>
                        <div class="flex items-center justify-between gap-6">
                            <div class="relative w-[55%] flex justify-center items-center flex-shrink-0">
                                <svg width="140" height="140" viewBox="0 0 150 150" class="transform -rotate-90">
                                    <circle cx="75" cy="75" r="65" stroke="#f3f4f6" stroke-width="14" fill="transparent" />
                                    <circle id="circle-protein" cx="75" cy="75" r="65" stroke="#f87171" stroke-width="14" fill="transparent" stroke-dasharray="408.4" stroke-dashoffset="408.4" stroke-linecap="butt" class="macro-circle" />
                                    <circle id="circle-carbs" cx="75" cy="75" r="65" stroke="#fdba74" stroke-width="14" fill="transparent" stroke-dasharray="408.4" stroke-dashoffset="408.4" stroke-linecap="butt" class="macro-circle" />
                                    <circle id="circle-fat" cx="75" cy="75" r="65" stroke="#7dd3fc" stroke-width="14" fill="transparent" stroke-dasharray="408.4" stroke-dashoffset="408.4" stroke-linecap="butt" class="macro-circle" />
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                    <span id="val-kcal-center" class="text-2xl font-black text-gray-900 leading-none tracking-tighter">0</span>
                                    <span class="text-[8px] font-black uppercase tracking-widest text-gray-400 mt-1.5">kcal</span>
                                </div>
                            </div>
                            <div id="modal-macros" class="w-[45%] flex flex-col gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pgyxzuehdnahoyxagwzr.supabase.co'; 
        const SUPABASE_ANON_KEY = 'sb_publishable_zT8C817F-niuGOA4bA9Jbg_vz-VsYQq';

        let supabaseClient = null;
        if (SUPABASE_URL && SUPABASE_URL.startsWith('http')) {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        let rawData = [];
        const THEMES = {
            LIGHT: { key: 'LIGHT', is: 'Light', en: 'Light', color: '#34d399', descIs: 'Næringarríkt án auka hitaeininga', descEn: 'Nutritious & light' },
            BALANCE: { key: 'BALANCE', is: 'Balance', en: 'Balance', color: '#38bdf8', descIs: 'Stuðlar að einbeitingu og jafnvægi', descEn: 'Focus & balance' },
            ENERGY: { key: 'ENERGY', is: 'Energy', en: 'Energy', color: '#fb923c', descIs: 'Gefur þér orkuna som þú þarft', descEn: 'Energy boost' },
            STRENGTH: { key: 'STRENGTH', is: 'Strength', en: 'Strength', color: '#ef4444', descIs: 'Byggir upp og styrkir líkamann', descEn: 'Build & strengthen' }
        };
        const CATEGORIES = {
            'DRYKKIR': { is: 'Drykkir', en: 'Drinks', img: 'https://images.prismic.io/worldclass/aVxY43NYClf9ozUz_menu_21920.jpg?auto=format,compress' },
            'SALAT': { is: 'Salöt', en: 'Salads', img: 'https://images.prismic.io/worldclass/aVxTN3NYClf9ozUA_menu_11920.jpg' },
            'GRAUTUR': { is: 'Grautar', en: 'Porridge', img: 'https://images.prismic.io/worldclass/aVxTOnNYClf9ozUD_menu_41920.jpg' },
            'KRISP': { is: 'Krisp', en: 'Crisp', img: 'https://images.prismic.io/worldclass/aVxTOXNYClf9ozUC_menu_31920.jpg' },
            'SKOT': { is: 'Skot', en: 'Shots', img: 'https://images.prismic.io/worldclass/aXQ3CAIvOtkhB5aW_skot.jpg' },
            'BÖRN': { is: 'Börn', en: 'Kids', img: 'https://images.prismic.io/worldclass/aVxTOHNYClf9ozUB_menu_21920.jpg' },
            'KAFFI': { is: 'Kaffi', en: 'Coffee', img: 'https://kitchenaid.com.au/cdn/shop/articles/Untitled_design_22_a34b9e85-b904-4444-b67b-c0cb895357ea.png?v=1728611009' },
            'GRÍPTU MEÐ': { is: 'Gríptu með', en: 'Grab & Go', img: 'https://images.prismic.io/worldclass/aXQ2UQIvOtkhB5U_gripamed.jpg?auto=format,compress' }
        };
        const IS_LANG = { tagline: 'þín orka, þinn árangur.', kcal: 'Kcal', S: 'Lítill', M: 'Mið', L: 'Stór', protein: 'Prótein', fat: 'Fita', carbs: 'Kolvetni', fiber: 'Trefjar' };
        const EN_LANG = { tagline: 'Your energy, your success.', kcal: 'Kcal', S: 'Small', M: 'Medium', L: 'Large', protein: 'Protein', fat: 'Fat', carbs: 'Carbs', fiber: 'Fiber' };

        let lastAnimatedMacros = { kcal: 0, protein: 0, fat: 0, carbs: 0, fiber: 0 };
        let currentCircleStates = { protein: { offset: 408.4, rotate: 0 }, carbs: { offset: 408.4, rotate: 0 }, fat: { offset: 408.4, rotate: 0 } };
        
        let state = { 
            isIcelandic: true, 
            viewMode: 'categories', 
            activeCategory: 'DRYKKIR', 
            activeTheme: null, 
            activeLocation: 'LAUGAR', 
            selectedSize: 'M', 
            sortBy: 'category', 
            sortOrder: 'asc', 
            modalItem: null 
        };

        const getLang = () => state.isIcelandic ? IS_LANG : EN_LANG;

        async function fetchMenuFromSupabase() {
            if (!supabaseClient) return;
            try {
                const { data, error } = await supabaseClient.from('menu_items').select('*');
                if (error) throw error;
                rawData = data.map(item => ({ ...item, nameIs: item.name_is, nameEn: item.name_en, descriptionIs: item.description_is, descriptionEn: item.description_en, isVegan: item.is_vegan }));
                const overlay = document.getElementById('loading-overlay');
                if (overlay) { overlay.style.opacity = '0'; setTimeout(() => overlay.remove(), 500); }
                
                // Lesa URL breytur eftir að gögn eru hlaðin
                const params = new URLSearchParams(window.location.search);
                const langParam = params.get('lang');
                if (langParam && langParam.toLowerCase() === 'en') {
                    state.isIcelandic = false;
                }
                
                const locParam = params.get('loc');
                if (locParam) {
                    state.activeLocation = locParam.toUpperCase();
                    const locMap = { 'LAUGAR': 'Laugar', 'VATNSMYRI': 'Vatnsmýri', 'SELTJARNARNES': 'Seltjarnarnes' };
                    const activeLocNameEl = document.getElementById('active-loc-name');
                    if (activeLocNameEl) activeLocNameEl.textContent = locMap[state.activeLocation] || state.activeLocation;
                }

                const available = getAvailableCategories();
                if (available.length > 0 && !available.includes(state.activeCategory)) {
                    state.activeCategory = available[0];
                }

                render();
                updateFlagAndLabel();
                checkAndTriggerNudge();
            } catch (err) { console.error("Error:", err); }
        }

        function checkAndTriggerNudge() {
            setTimeout(() => {
                const container = document.getElementById('category-scroll-container');
                const tabs = document.getElementById('category-tabs');
                if (container && tabs && container.scrollWidth > container.clientWidth) {
                    tabs.classList.add('nudge-active');
                }
            }, 1800);
        }

        function toggleLocMenu() { document.getElementById('loc-dropdown').classList.toggle('active'); }
        
        function setLocation(loc) { 
            state.activeLocation = loc.toUpperCase(); 
            const locMap = { 'LAUGAR': 'Laugar', 'VATNSMYRI': 'Vatnsmýri', 'SELTJARNARNES': 'Seltjarnarnes' };
            const activeLocNameEl = document.getElementById('active-loc-name');
            if (activeLocNameEl) activeLocNameEl.textContent = locMap[state.activeLocation] || state.activeLocation; 
            document.getElementById('loc-dropdown').classList.remove('active'); 
            
            const available = getAvailableCategories();
            if (available.length > 0 && !available.includes(state.activeCategory)) {
                state.activeCategory = available[0];
            }
            render(); 
        }
        
        function toggleLanguage() { state.isIcelandic = !state.isIcelandic; updateFlagAndLabel(); render(); }
        
        function updateFlagAndLabel() { 
            const img = document.getElementById('lang-flag-img');
            if (img) img.src = state.isIcelandic ? "https://flagcdn.com/w80/is.png" : "https://flagcdn.com/w80/gb.png"; 
        }
        
        function setViewMode(mode) { state.viewMode = mode; if (mode === 'categories') state.activeCategory = getAvailableCategories()[0] || 'DRYKKIR'; else state.activeTheme = 'LIGHT'; render(); scrollToMenuAnchor(); }
        
        function scrollToMenuAnchor() { setTimeout(() => { const anchor = document.getElementById('scroll-anchor'); if (anchor) window.scrollTo({ top: anchor.getBoundingClientRect().top + window.pageYOffset - 32, behavior: 'smooth' }); }, 100); }
        
        function setSort(type) { 
            if (state.sortBy === type) {
                state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortBy = type;
                state.sortOrder = 'asc';
            }
            render(); 
        }

        function toggleSortOrder() {
            state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
            render();
        }

        function getAvailableCategories() {
            const categoriesAtLoc = new Set();
            rawData.forEach(item => { if (item.locations?.includes(state.activeLocation)) categoriesAtLoc.add(item.category); });
            return Object.keys(CATEGORIES).filter(key => categoriesAtLoc.has(key));
        }

        function animateSynchronized(targetMacros) {
            const startMacros = Object.assign({}, lastAnimatedMacros);
            const endMacros = { kcal: targetMacros.kcal || 0, protein: targetMacros.protein || 0, carbs: targetMacros.carbs || 0, fat: targetMacros.fat || 0, fiber: targetMacros.fiber || 0 };
            const circ = 408.4; const duration = 1000; 
            const total = endMacros.protein + endMacros.carbs + endMacros.fat || 1;
            const targetRatios = { p: endMacros.protein / total, c: endMacros.carbs / total, f: endMacros.fat / total };
            const targetVisuals = { protein: { offset: circ - (targetRatios.p * circ), rotate: 0 }, carbs: { offset: circ - (targetRatios.c * circ), rotate: targetRatios.p * 360 }, fat: { offset: circ - (targetRatios.f * circ), rotate: (targetRatios.p + targetRatios.c) * 360 } };
            const startVisuals = JSON.parse(JSON.stringify(currentCircleStates));
            const elements = { protein: document.getElementById('circle-protein'), carbs: document.getElementById('circle-carbs'), fat: document.getElementById('circle-fat'), valK: document.getElementById('val-kcal-center') };
            let startTime = null;
            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;
                elements.valK.textContent = Math.round(startMacros.kcal + (endMacros.kcal - startMacros.kcal) * ease);
                ['protein', 'carbs', 'fat', 'fiber'].forEach(key => { const el = document.getElementById('val-' + key); if (el) el.textContent = Math.round(startMacros[key] + (endMacros[key] - startMacros[key]) * ease) + 'g'; });
                ['protein', 'carbs', 'fat'].forEach(key => {
                    const currentOffset = startVisuals[key].offset + (targetVisuals[key].offset - startVisuals[key].offset) * ease;
                    const currentRotate = startVisuals[key].rotate + (targetVisuals[key].rotate - startVisuals[key].rotate) * ease;
                    elements[key].style.strokeDashoffset = currentOffset;
                    elements[key].style.transform = `rotate(${currentRotate}deg)`;
                    currentCircleStates[key].offset = currentOffset; currentCircleStates[key].rotate = currentRotate;
                });
                if (progress < 1) requestAnimationFrame(step); 
                else { lastAnimatedMacros = Object.assign({}, endMacros); currentCircleStates = JSON.parse(JSON.stringify(targetVisuals)); }
            }
            requestAnimationFrame(step);
        }

        function resetMacroVisuals() {
            const circ = 408.4; const elements = { protein: document.getElementById('circle-protein'), carbs: document.getElementById('circle-carbs'), fat: document.getElementById('circle-fat'), valK: document.getElementById('val-kcal-center') };
            if (elements.protein) { elements.protein.style.strokeDashoffset = circ; elements.carbs.style.strokeDashoffset = circ; elements.fat.style.strokeDashoffset = circ; elements.protein.style.transform = 'rotate(0deg)'; elements.carbs.style.transform = 'rotate(0deg)'; elements.fat.style.transform = 'rotate(0deg)'; }
            if (elements.valK) elements.valK.textContent = '0';
            ['protein', 'carbs', 'fat', 'fiber'].forEach(key => { if (document.getElementById('val-' + key)) document.getElementById('val-' + key).textContent = '0g'; });
            currentCircleStates = { protein: { offset: circ, rotate: 0 }, carbs: { offset: circ, rotate: 0 }, fat: { offset: circ, rotate: 0 } };
            lastAnimatedMacros = { kcal: 0, protein: 0, fat: 0, carbs: 0, fiber: 0 };
        }

        function updateSwoosh() {
            const activeTab = document.querySelector('.active-tab');
            const indicator = document.getElementById('nav-indicator');
            if (activeTab && indicator) {
                indicator.style.width = activeTab.offsetWidth + 'px';
                indicator.style.left = activeTab.offsetLeft + 'px';
                indicator.style.opacity = "1";
                activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            } else if (indicator) indicator.style.opacity = "0";
        }

        function updateSortSwoosh() {
            const activeSort = document.querySelector('.active-sort');
            const indicator = document.getElementById('sort-indicator');
            if (activeSort && indicator) { 
                indicator.style.width = activeSort.offsetWidth + 'px'; 
                indicator.style.left = activeSort.offsetLeft + 'px'; 
                indicator.style.opacity = "1"; 

                const colors = { kcal: '#000000', protein: '#ef4444', carbs: '#f97316', fat: '#0ea5e9', category: '#ef4444' };
                indicator.style.backgroundColor = colors[state.sortBy] || '#ef4444';
            } else if (indicator) {
                indicator.style.opacity = "0";
            }
        }

        function render() {
            const lang = getLang();
            document.getElementById('tagline').textContent = lang.tagline;
            document.querySelectorAll('.view-toggle-btn').forEach(btn => { const active = btn.id === 'mode-' + state.viewMode; btn.classList.toggle('bg-white', active); btn.classList.toggle('text-gray-900', active); btn.classList.toggle('text-gray-400', !active); });
            document.getElementById('category-container').classList.toggle('hidden', state.viewMode !== 'categories');
            document.getElementById('theme-container').classList.toggle('hidden', state.viewMode !== 'themes');
            renderNav(); renderThemeButtons(); renderHero(); renderGrid();
            
            setTimeout(() => { updateSwoosh(); updateSortSwoosh(); }, 50);
        }

        function renderNav() {
            const container = document.getElementById('category-tabs');
            const availableCategories = getAvailableCategories();
            const existingTabs = container.querySelectorAll('.category-tab');
            existingTabs.forEach(tab => tab.remove());
            availableCategories.forEach(key => {
                const info = CATEGORIES[key];
                const active = state.activeCategory === key;
                const btn = document.createElement('button');
                btn.onclick = () => { state.activeCategory = key; render(); scrollToMenuAnchor(); };
                btn.className = `category-tab flex-1 text-center transition-all ${active ? 'active-tab text-white' : 'text-gray-400'}`;
                btn.textContent = state.isIcelandic ? info.is : info.en;
                container.appendChild(btn);
            });
        }

        function renderThemeButtons() {
            const container = document.getElementById('theme-container');
            container.innerHTML = ['LIGHT', 'BALANCE', 'ENERGY', 'STRENGTH'].map(key => {
                const t = THEMES[key]; const active = state.activeTheme === t.key;
                return `<button onclick="state.activeTheme='${t.key}';render();scrollToMenuAnchor()" class="p-4 rounded-3xl flex items-start gap-3 bg-white border border-gray-100 transition-all ${active ? 'ring-2 ring-red-500 shadow-lg' : ''}" style="color:${t.color}"><div class="w-2.5 h-2.5 rounded-full mt-1 flex-shrink-0" style="background-color:${t.color}"></div><div><h5 class="text-[10px] font-black uppercase tracking-widest mb-1 text-gray-900">${state.isIcelandic ? t.is : t.en}</h5><p class="text-[9px] text-gray-400 leading-tight">${state.isIcelandic ? t.descIs : t.descEn}</p></div></button>`;
            }).join('');
        }

        function renderHero() {
            const hero = document.getElementById('category-hero');
            const heroImg = document.getElementById('hero-img');
            const heroTitle = document.getElementById('hero-title');
            const overlay = document.getElementById('hero-color-overlay');
            let src="", title="", color="", op="0";
            if (state.viewMode==='themes' && state.activeTheme) { const t = THEMES[state.activeTheme]; src="https://images.prismic.io/worldclass/aVxTO3NYClf9ozUE_menu1920.jpg"; title=state.isIcelandic?t.is:t.en; color=t.color; op="0.5"; }
            else if (state.viewMode==='categories' && state.activeCategory) { const c = CATEGORIES[state.activeCategory]; src=c.img; title=state.isIcelandic?c.is:c.en; }
            if (src) { hero.classList.remove('hidden'); heroImg.src=src; heroTitle.textContent=title; overlay.style.backgroundColor=color; overlay.style.opacity=op; } else hero.classList.add('hidden');
        }

        function renderGrid() {
            const container = document.getElementById('menu-grid');
            const lang = getLang();
            let items = rawData.filter(i => i.locations?.includes(state.activeLocation));
            
            if (state.viewMode==='themes' && state.activeTheme) items = items.filter(i => i.theme === state.activeTheme || i.theme === 'ALL');
            else if (state.viewMode==='categories' && state.activeCategory) items = items.filter(i => i.category === state.activeCategory);

            const themePriority = { 'LIGHT': 1, 'BALANCE': 2, 'ENERGY': 3, 'STRENGTH': 4, 'ALL': 5 };

            if (state.sortBy !== 'category') {
                items.sort((a, b) => {
                    const getVal = (item) => {
                        const m = item.prices ? item.macros.M : item.macros;
                        return m ? (m[state.sortBy] || 0) : 0;
                    };
                    return state.sortOrder === 'asc' ? getVal(a) - getVal(b) : getVal(b) - getVal(a);
                });
            } else {
                items.sort((a, b) => {
                    const pA = themePriority[a.theme] || 99;
                    const pB = themePriority[b.theme] || 99;
                    if (pA !== pB) return state.sortOrder === 'asc' ? pA - pB : pB - pA;
                    const nameA = state.isIcelandic ? (a.nameIs || "") : (a.nameEn || "");
                    const nameB = state.isIcelandic ? (b.nameIs || "") : (b.nameEn || "");
                    return state.sortOrder === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
                });
            }

            const highlightConfig = {
                kcal: { bg: 'bg-black/5', text: 'text-black', label: 'text-black/60' },
                protein: { bg: 'bg-red-50', text: 'text-red-500', label: 'text-red-400' },
                carbs: { bg: 'bg-orange-50', text: 'text-orange-500', label: 'text-orange-400' },
                fat: { bg: 'bg-blue-50', text: 'text-blue-500', label: 'text-blue-400' }
            };

            const highlightClass = (key) => state.sortBy === key ? `${highlightConfig[key].bg} rounded-2xl shadow-sm scale-110 z-10 p-1.5 -m-1.5` : 'p-1';
            const labelColor = (key, defaultClass) => state.sortBy === key ? highlightConfig[key].label : defaultClass;
            const valueColor = (key, defaultClass) => state.sortBy === key ? highlightConfig[key].text : defaultClass;

            const arrowSvg = `<svg class="sort-arrow-svg ${state.sortOrder === 'desc' ? 'desc' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 15l7-7 7 7"></path></svg>`;

            document.querySelectorAll('.sort-btn').forEach(btn => {
                const key = btn.id.replace('sort-', '');
                const isActive = key === state.sortBy;
                btn.classList.toggle('active-sort', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('text-gray-400', !isActive);
                const baseText = key === 'kcal' ? lang.kcal : key === 'protein' ? 'PRÓT' : key === 'carbs' ? 'KOLV' : key === 'fat' ? 'FITA' : 'FLOKKAR';
                btn.innerHTML = baseText + (isActive ? arrowSvg : '');
            });

            container.innerHTML = items.map(item => {
                const theme = THEMES[item.theme] || { color:'#9ca3af' };
                const price = item.prices?.M || item.price;
                const m = item.prices ? item.macros.M : item.macros;

                return `<div class="item-card bg-white p-7 rounded-[2.2rem] border border-gray-50 shadow-sm cursor-pointer" onclick="openModal(${rawData.indexOf(item)})">
                    <div class="flex justify-between items-start mb-4"><span class="text-[8px] font-black px-2 py-0.5 rounded-md text-white uppercase tracking-widest" style="background-color:${theme.color}">${state.isIcelandic ? (THEMES[item.theme]?.is || '') : (THEMES[item.theme]?.en || '')}</span><span class="text-base font-black text-red-500 tracking-tight block leading-none">${price || ''}</span></div>
                    <h3 class="text-xl sm:text-2xl font-black text-gray-900 mb-2 tracking-tight leading-tight">${state.isIcelandic?item.nameIs:item.nameEn}</h3>
                    <p class="text-gray-400 text-xs leading-relaxed line-clamp-2 mb-4">${state.isIcelandic?item.descriptionIs:item.descriptionEn}</p>
                    ${m ? `<div class="card-macro-grid grid grid-cols-4 gap-2 items-center text-center">
                        <div class="flex flex-col transition-all duration-300 ${highlightClass('kcal')}"><span class="text-[7px] uppercase font-black ${labelColor('kcal', 'text-gray-300')}">${lang.kcal}</span><span class="text-[11px] font-black ${valueColor('kcal', 'text-gray-800')}">${Math.round(m.kcal)}</span></div>
                        <div class="flex flex-col transition-all duration-300 ${highlightClass('protein')}"><span class="text-[7px] uppercase font-black ${labelColor('protein', 'text-red-400')}">PRÓT</span><span class="text-[11px] font-black ${valueColor('protein', 'text-gray-800')}">${Math.round(m.protein)}g</span></div>
                        <div class="flex flex-col transition-all duration-300 ${highlightClass('carbs')}"><span class="text-[7px] uppercase font-black ${labelColor('carbs', 'text-orange-400')}">KOLV</span><span class="text-[11px] font-black ${valueColor('carbs', 'text-gray-800')}">${Math.round(m.carbs)}g</span></div>
                        <div class="flex flex-col transition-all duration-300 ${highlightClass('fat')}"><span class="text-[7px] uppercase font-black ${labelColor('fat', 'text-blue-400')}">FITA</span><span class="text-[11px] font-black ${valueColor('fat', 'text-gray-800')}">${Math.round(m.fat)}g</span></div>
                    </div>` : ''}
                </div>`;
            }).join('');
            container.querySelectorAll('.item-card').forEach((c, i) => setTimeout(() => c.classList.add('visible'), i*80));
        }

        async function shareAsImage() {
            const container = document.getElementById('export-container');
            const exportLogo = document.getElementById('modal-logo-export');
            const btns = document.querySelectorAll('.export-hide');
            if (exportLogo) exportLogo.classList.remove('hidden');
            btns.forEach(b => b.style.display = 'none');
            try { const canvas = await html2canvas(container, { backgroundColor: '#ffffff', borderRadius: 48, scale: 3, useCORS: true, logging: false, imageTimeout: 0, dpi: 300 }); const link = document.createElement('a'); link.download = `menu-${state.modalItem.nameIs || 'item'}.png`; link.href = canvas.toDataURL('image/png'); link.click(); } 
            catch (err) { console.error("Error:", err); } finally { if (exportLogo) exportLogo.classList.add('hidden'); btns.forEach(b => b.style.display = ''); }
        }

        function openModal(idx) {
            const item = rawData[idx]; if (!item) return;
            state.modalItem = item; state.selectedSize = item.prices ? 'M' : null;
            resetMacroVisuals();
            document.getElementById('modal-title').textContent = state.isIcelandic ? item.nameIs : item.nameEn;
            document.getElementById('modal-description').textContent = state.isIcelandic ? item.descriptionIs : item.descriptionEn;
            const themeInfo = THEMES[item.theme] || { is: '', en: '', color: '#9ca3af' };
            document.getElementById('modal-tag').textContent = state.isIcelandic ? themeInfo.is : themeInfo.en;
            document.getElementById('modal-tag').style.backgroundColor = themeInfo.color;
            document.getElementById('modal-vegan').classList.toggle('hidden', !item.isVegan);
            updateModalUI();
            const modal = document.getElementById('item-modal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => { document.getElementById('modal-content').classList.remove('opacity-0', 'scale-95'); document.getElementById('modal-content').classList.add('opacity-100', 'scale-100'); const m = item.macros ? (item.prices ? item.macros[state.selectedSize] : item.macros) : null; if (m) animateSynchronized(m); }, 50);
        }

        function updateModalUI() {
            const item = state.modalItem; const lang = getLang();
            const pCont = document.getElementById('modal-price-container');
            const mCont = document.getElementById('modal-macros');
            if (item.prices) { const sizeOrder = ['S', 'M', 'L']; pCont.innerHTML = `<div class="grid grid-cols-3 gap-2">${sizeOrder.filter(s => item.prices[s]).map(s => `<button onclick="state.selectedSize='${s}';updateModalUI();animateSynchronized(state.modalItem.macros[state.selectedSize])" class="flex flex-col items-center py-2.5 rounded-2xl border ${state.selectedSize===s?'border-red-400 bg-red-50 text-red-500 font-black':'border-gray-100'}"><span class="text-[9px] uppercase font-black">${lang[s]}</span><span class="text-sm font-bold">${item.prices[s]}</span></button>`).join('')}</div>`; } else { pCont.innerHTML = `<span class="text-3xl font-black text-red-500 tracking-tighter">${item.price || ''}</span>`; }
            const m = item.macros ? (item.prices ? item.macros[state.selectedSize] : item.macros) : null;
            if (m) {
                document.getElementById('modal-nutrition-section').classList.remove('hidden');
                const rows = [{k:'protein', c:'text-[#dc2626]', bg:'bg-[#fff1f2]'},{k:'carbs', c:'text-[#ea580c]', bg:'bg-[#fff7ed]'},{k:'fat', c:'text-[#0284c7]', bg:'bg-[#f0f9ff]'},{k:'fiber', c:'text-[#16a34a]', bg:'bg-[#f0fdf4]'}];
                mCont.innerHTML = rows.map(r => `<div class="${r.bg} px-5 py-2.5 rounded-[1.4rem] flex items-center justify-between border border-white/50 shadow-sm w-full"><span class="text-[6.5px] font-black uppercase tracking-[0.2em] ${r.c}">${lang[r.k]}</span><span id="val-${r.k}" class="text-sm font-black text-gray-800 w-14 text-right">0g</span></div>`).join('');
            } else { document.getElementById('modal-nutrition-section').classList.add('hidden'); }
        }

        function closeModal() { const modal = document.getElementById('item-modal'); document.getElementById('modal-content').classList.remove('opacity-100', 'scale-100'); document.getElementById('modal-content').classList.add('opacity-0', 'scale-95'); setTimeout(() => { modal.classList.remove('flex'); modal.classList.add('hidden'); resetMacroVisuals(); }, 300); }

        window.onload = function() {
            fetchMenuFromSupabase();
            
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('item-modal');
                    if (modal && !modal.classList.contains('hidden')) {
                        closeModal();
                    }
                }
            });
        };
    </script>
</body>
</html>
